# RIME 閩拚輸入法安裝程式打包指南

## 概述

本指南說明如何使用 PyInstaller 將 `rime_installer.py` 打包成獨立的 `.exe` 執行檔，讓使用者無需安裝 Python 環境即可使用。

## 為什麼需要打包？

### 優點

- ✅ **環境獨立**：使用者無需安裝 Python
- ✅ **簡化分發**：只需一個 `.exe` 檔案
- ✅ **提高相容性**：適用於各種 Windows 環境
- ✅ **使用者友善**：一般使用者更熟悉 `.exe` 檔案
- ✅ **安全性**：避免 Python 版本衝突問題

### 適用情境

- 面向一般使用者的軟體分發
- 企業內部部署
- 不確定目標環境是否有 Python

## 檔案結構

```PowerShell
tools/
├── rime_installer.py          # 原始安裝程式
├── build_installer.py         # 打包工具腳本
├── build_installer.bat        # Windows 批次檔（簡化執行）
├── rime_installer.spec        # PyInstaller 規格檔（自動生成）
└── 打包說明.md                # 本說明檔
```

## 使用方法

### 方法一：使用批次檔（推薦）

1. 雙擊 `build_installer.bat`
2. 等待打包完成
3. 檢查 `../release/installer_package/` 目錄

### 方法二：手動執行

```powershell
# 切換到 tools 目錄
cd tools

# 執行打包腳本
python build_installer.py
```

## 打包流程詳解

### 1. 環境檢查

- 檢查 Python 是否安裝
- 檢查 PyInstaller 是否可用
- 自動安裝 PyInstaller（如果需要）

### 2. 創建規格檔案

自動生成 `rime_installer.spec`，包含：

- 主程式入口點
- 資源檔案配置
- 建置選項設定

### 3. 執行打包

使用 PyInstaller 將 Python 腳本轉換為獨立執行檔

### 4. 創建分發包

在 `../release/installer_package/` 目錄中創建完整的安裝包：

```PowerShell
installer_package/
├── rime_installer.exe         # 主執行檔
├── rime_files/                # RIME 配置檔案
├── config/                    # 額外配置檔案
├── release-include.txt        # 檔案清單
├── README.md                  # 專案說明
└── 安裝說明.txt               # 使用說明
```

## 打包選項說明

### PyInstaller 重要參數

- `--onefile`: 打包成單一執行檔
- `--noconsole`: 不顯示控制台視窗（GUI 應用）
- `--console`: 顯示控制台視窗（CLI 應用）
- `--add-data`: 包含額外資料檔案
- `--icon`: 設定執行檔圖示

### 本專案的配置

```python
# 資料檔案配置
datas=[
    ('../release-include.txt', '.'),    # 檔案清單
    ('../rime_files', 'rime_files'),    # RIME 檔案目錄
    ('../config', 'config'),            # 配置目錄
]

# 執行檔配置
console=True,          # 顯示控制台（因為是命令列工具）
upx=True,             # 啟用 UPX 壓縮
debug=False,          # 發行版本
```

## 故障排除

### 常見問題

#### 1. PyInstaller 安裝失敗

```bash
# 手動安裝
pip install pyinstaller

# 使用國內鏡像
pip install -i https://pypi.tuna.tsinghua.edu.cn/simple pyinstaller
```

#### 2. 缺少模組錯誤

在 `rime_installer.spec` 的 `hiddenimports` 中添加缺少的模組：

```python
hiddenimports=['missing_module_name'],
```

#### 3. 資料檔案找不到

檢查 `datas` 配置中的路徑是否正確：

```python
datas=[
    ('source_path', 'destination_path'),
]
```

#### 4. 執行檔過大

- 啟用 UPX 壓縮：`upx=True`
- 排除不需要的模組：`excludes=['unnecessary_module']`
- 使用 `--onedir` 替代 `--onefile`

#### 5. 防毒軟體誤報

- 使用程式碼簽名證書
- 提交到防毒軟體廠商進行白名單申請
- 在分發時說明可能的誤報情況

### 除錯技巧

#### 啟用除錯模式

在 spec 檔案中設定：

```python
debug=True,
console=True,
```

#### 檢查相依性

```bash
# 列出所有相依模組
pyi-makespec --debug=all rime_installer.py
```

#### 測試打包結果

```bash
# 在不同環境測試執行檔
.\dist\rime_installer.exe
```

## 最佳實務

### 1. 版本管理

- 在檔案名稱中包含版本號
- 使用 Git 標籤標記發行版本

### 2. 測試流程

- 在乾淨的 Windows 環境測試
- 測試不同版本的 Windows
- 確認所有功能正常運作

### 3. 分發策略

- 提供完整的安裝說明
- 包含系統需求說明
- 提供技術支援聯絡方式

### 4. 安全考量

- 使用程式碼簽名
- 定期更新相依套件
- 監控安全漏洞

## 進階設定

### 自訂圖示

將 `.ico` 檔案放在 `assets/` 目錄，並在 spec 檔案中設定：

```python
icon='../assets/icon.ico'
```

### 版本資訊

在 spec 檔案中添加版本資訊：

```python
version='version_info.txt'
```

### 多語言支援

確保包含所有語言資源檔案：

```python
datas=[
    ('locales/', 'locales/'),
]
```

## 部署檢查清單

- [ ] ✅ 執行檔正常運作
- [ ] ✅ 所有資源檔案包含完整
- [ ] ✅ 在目標環境測試成功
- [ ] ✅ 檔案大小合理
- [ ] ✅ 啟動時間可接受
- [ ] ✅ 防毒軟體掃描通過
- [ ] ✅ 使用說明完整
- [ ] ✅ 版本號正確

## 相關資源

- [PyInstaller 官方文檔](https://pyinstaller.readthedocs.io/)
- [Python 打包指南](https://packaging.python.org/)
- [Windows 程式碼簽名指南](https://docs.microsoft.com/en-us/windows/win32/seccrypto/signtool)

---

**注意**: 本指南適用於 Windows 環境。其他作業系統請參考相應的打包方法。