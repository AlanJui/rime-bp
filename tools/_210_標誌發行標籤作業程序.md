# 標誌發行標籤作業程序

為本地端之【版本倉】，設立【版本標籤】。

## 標籤(Tag)基本操作

適用：Git / GitHub。包含「建立、刪除、修正 tag」與「搭配 Release」的常用指令與排錯要點。

---

### 1) 檢視與建立 Tag

```bash
# 列出所有 tag
git tag --list

# 建立「輕量」tag（lightweight）
git tag v1.2.3

# 建立「註解」tag（annotated，推薦）
git tag -a v1.2.3 -m "v1.2.3"
# 或 GPG 簽名：git tag -s v1.2.3 -m "v1.2.3"
```

---

### 2) 推送／抓取 Tag

```bash
# 推送單一 tag
git push origin v1.2.3

# 一次推送所有本地 tag
git push origin --tags

# 抓取遠端所有 tag（並修剪已刪除者）
git fetch origin --tags --prune --prune-tags
```

---

### 3) 刪除標籤 Tag

```bash
# 刪本機
git tag -d v1.2.3

# 刪遠端
git push origin --delete v1.2.3
# 或：git push origin :refs/tags/v1.2.3
```

> 小提醒：將遠端【版本倉】之【標籤】刪除後，專案成員之【本端】還會殘留已被刪除之【標籤】資訊，需請【專案成員】們各自於本機端執行此指令： `git fetch origin --prune --prune-tags` ，以便能將不復存在之標籤清理掉。

---

### 4) 更正標籤指向簽入設定之錯誤

標籤之建立，可透過【簽入摘要】，使之【指向】某次【簽入（Commit）】作業，以此方式使【標籤】與【簽入】産生連結關係。

若是【標籤】指向之【簽入】設定有誤，且已自【本端】推送至【遠端】，可循下列之指令操作，完成更正作業。

```bash
# (A) 先刪遠端舊 tag
git push origin --delete v1.2.3

# (B) 在正確 commit 重建/改指向（建議用註解 tag）
git tag -fa v1.2.3 [正確commitSHA] -m "v1.2.3"

# (C) 推送新的 tag
git push origin v1.2.3
```

---

### 5) GitHub Release

使用 GitHub CLI: gh，執行 New Relase Action 作業。

```bash
# 建立 Release（tag 已存在）
gh release create v1.2.3 -t "v1.2.3" -n "變更說明..."

# 指定目標分支/commit（tag 尚未存在時）
gh release create v1.2.3 --target main -t "v1.2.3" -n "變更說明..."

# 刪除 Release（保留 tag）
gh release delete v1.2.3 --yes
```

---

### 6) GitHub Actions（自動發行）必要權限

為使 GitHub Actions workflow 能自動觸發，在 YAML 腳本檔，
需有如下之 script ，以便設定：【寫入】權限。

```yaml
permissions:
  contents: write
```

- 若用 `softprops/action-gh-release@v2`：

  ```yaml
  - uses: softprops/action-gh-release@v2
    with:
      tag_name: ${{ steps.meta.outputs.TAG }}
      target_commitish: ${{ steps.meta.outputs.REF }}
      prerelease: ${{ github.event.inputs.prerelease || false }}
      files: |
        dist/*.zip
        dist/*.sha256
  ```

- 若遇 403：檢查 workflow `permissions: contents: write`、Repo 的 **Settings → Actions → Workflow permissions** 是否開 **Read and write**；或改用 PAT（`token:` 指定 secrets）。

---

### 7) 常見錯誤與排解

- **`tag 'vX.Y.Z' already exists`**：本機已存在；改名或先 `git tag -d vX.Y.Z`。遠端同名時，請先刪遠端再推。
- **`Resource not accessible by integration`（403）**：GitHub Actions 權限不足，需 `permissions: contents: write` 或 PAT。
- **想確認某 tag 指到哪裡**：

  ```bash
  git rev-parse v1.2.3
  git show v1.2.3 --no-patch --pretty=fuller
  ```

---

### 8) 進階：重寫歷史移除某檔（全庫清除）

> 若需要將敏感檔案在「所有歷史」中移除，請使用 `git filter-repo` 或 BFG，並 **強制推送**。操作前務必備份。

```bash
# 安裝（其中一種）
pip install git-filter-repo
# or: brew install git-filter-repo（macOS）

# 例：移除某檔（可重複 --path 多次）；--invert-paths = 移除符合者、保留其他
git filter-repo --path secret.txt --invert-paths

# 推送重寫後歷史（請注意會影響所有人）
git push origin --force --tags
```

## 使用 Bash Script 操作標籤

### 批次刪除標籤

`delete-tags-by-tags-list.sh`

使用方式：

1. 編輯陣列
   打開腳本，把 TAGS=( ... ) 內的 tag 名稱改成你要刪的清單。

```bash
...
TAGS=(
  "v0.5.1"
  "v0.5.2"
  # "kb-2024-09-30"
)
```

2. 執行 Bash Script

```bash
$ delete-tags-by-tags-list.sh
```

### 試跑（不動真格）

```bash
bash delete-tags.sh -n
```

### 正式刪遠端 tags（預設 origin）

```bash
bash delete-tags.sh -y
```

### 也刪本機 tag

```bash
bash delete-tags.sh -y --also-local
```

### 也刪同名 GitHub Release（需 gh 已登入）

```bash
bash delete-tags.sh -y --also-release
```

### 指定遠端（如果不是 origin）

```bash
bash delete-tags.sh -y --remote upstream
```

【補註】：

(1) 若遇到 保護的 tag 規則（Protected tags） 或權限不足，刪遠端會失敗；需調整 repo 設定或用有權限的帳號。

(2) --also-release 需要 gh 登入：gh auth login。

(3) 在 Windows Git Bash 上執行沒問題；若是 PowerShell 直接跑，請用 bash delete-tags.sh ...。
