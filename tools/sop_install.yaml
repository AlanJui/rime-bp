name: "é–©æ‹šè¼¸å…¥æ³• - å°ç‹¼æ¯«ï¼ˆRIMEï¼‰å®‰è£ä½œæ¥­ç¨‹åº"
version: "1.2.0"
description: >
  æ–¼ Windows 11 + å°ç‹¼æ¯«ï¼ˆWeaselï¼‰ç’°å¢ƒä¸­ï¼Œä½¿ç”¨ PowerShell å®Œæˆé–©æ‹šè¼¸å…¥æ³•é…ç½®æª”æ¡ˆçš„éƒ¨ç½²æµç¨‹ã€‚
  æ­¤æ–‡ä»¶æä¾›è‡ªå‹•èˆ‡æ‰‹å‹•å…©ç¨®ç¨‹åºï¼Œä¾åºåŸ·è¡Œå³å¯å®Œæˆå®‰è£èˆ‡é©—è­‰ã€‚

prerequisites:
  - "Windows 11ï¼Œä¸¦å·²å®‰è£å°ç‹¼æ¯«ï¼ˆWeaselï¼‰è¼¸å…¥æ³•ä¸»ç¨‹å¼ã€‚"
  - "PowerShell 5.1 (Windows PowerShell) æˆ– PowerShell 7 ä»¥ä¸Šç‰ˆæœ¬ã€‚"
  - "å·²ä¸‹è¼‰æœ¬å°ˆæ¡ˆå®Œæ•´è³‡æ–™å¤¾ï¼ˆå« releaseã€configã€tools ç­‰å­ç›®éŒ„ï¼‰ã€‚"
  - "å…·å‚™ Python 3.9+ï¼ˆåƒ…åœ¨åŸ·è¡Œè‡ªå‹•å®‰è£è…³æœ¬åŠé©—è­‰å·¥å…·æ™‚éœ€è¦ï¼‰ã€‚"

steps:
  - name: "åˆå§‹åŒ– PowerShell æœƒè©±èˆ‡ä¸»è¦è·¯å¾‘"
    run: |
      # è‡ªå°ˆæ¡ˆæ ¹ç›®éŒ„å•Ÿå‹• PowerShellï¼Œä¸¦æ–¼åŒä¸€å€‹å·¥ä½œéšæ®µä¸­ä¾åºåŸ·è¡Œå„æ­¥é©Ÿã€‚
      Set-ExecutionPolicy -Scope Process -ExecutionPolicy RemoteSigned -Force
      $ErrorActionPreference = "Stop"
      $ProjectRoot   = Convert-Path .
      $ReleaseRoot   = Join-Path $ProjectRoot 'release'
      $ToolsRoot     = Join-Path $ProjectRoot 'tools'
      $InstallerPy   = Join-Path $ToolsRoot 'rime_installer.py'
      $IncludeList   = Join-Path $ProjectRoot 'release-include.txt'
      $RimeDir       = Join-Path $env:APPDATA 'Rime'
      $Timestamp     = Get-Date -Format 'yyyyMMdd_HHmmss'
      Write-Host "ğŸ§­ ProjectRoot : $ProjectRoot"
      Write-Host "ğŸ“ ReleaseRoot : $ReleaseRoot"
      Write-Host "ğŸ“„ IncludeList : $IncludeList"
      Write-Host "ğŸ¡ RimeDir     : $RimeDir"
      Write-Host "ğŸ•’ Timestamp   : $Timestamp"

  - name: "æª¢æŸ¥å¿…è¦æ¢ä»¶èˆ‡å¯ç”¨è³‡æº"
    run: |
      $RimeDir = Join-Path $env:APPDATA 'Rime'
      if (-not (Test-Path $RimeDir)) {
        throw "æ‰¾ä¸åˆ° RIME è¨­å®šç›®éŒ„ï¼š$RimeDirï¼Œè«‹å…ˆå®‰è£å°ç‹¼æ¯«å†ç¹¼çºŒã€‚"
      }

      if (-not (Test-Path '.\release-include.txt')) {
        throw "release-include.txt æœªå°±ç·’ï¼Œç„¡æ³•åˆ¤å®šéœ€éƒ¨ç½²ä¹‹æª”æ¡ˆã€‚"
      }

      if (-not (Test-Path '.\release')) {
        throw "release ç›®éŒ„ç¼ºå¤±ï¼Œè«‹å…ˆä¾ _202_æ‰“åŒ…ä½œæ¥­ç¨‹åºæ›¸.md å»ºç½®ç™¼å¸ƒè³‡æºã€‚"
      }

      if (-not (Get-Command python -ErrorAction SilentlyContinue)) {
        throw "æœªæ‰¾åˆ° Python åŸ·è¡Œæª”ï¼Œè«‹å®‰è£ Python 3.9 ä»¥ä¸Šç‰ˆæœ¬ã€‚"
      }

      Write-Host "âœ… ç’°å¢ƒæª¢æŸ¥é€šéï¼Œå¯é€²è¡Œä¸‹ä¸€æ­¥ã€‚"

  - name: "è§£å£“èˆ‡åŒæ­¥ç™¼ä½ˆè³‡æºï¼ˆå¦‚æœ‰æœ€æ–° ZIPï¼‰"
    run: |
      $ReleaseRoot = Join-Path (Convert-Path .) 'release'
      $RimeFilesDir = Join-Path $ReleaseRoot 'rime_files'

      if (-not (Test-Path $RimeFilesDir)) {
        Write-Host "âš ï¸  æœªç™¼ç¾ release\rime_filesï¼Œå°‡å˜—è©¦è§£å£“æœ€æ–° ZIPã€‚"
        $LatestZip = Get-ChildItem -Path $ReleaseRoot -Filter '*.zip' |
                     Sort-Object LastWriteTime -Descending |
                     Select-Object -First 1
        if ($null -eq $LatestZip) {
          throw "release ç›®éŒ„å…§ä¸å­˜åœ¨ ZIP å¥—ä»¶ï¼Œè«‹å…ˆå»ºç½®æˆ–ä¸‹è¼‰æ­£å¼å®‰è£åŒ…ã€‚"
        }

        $TempExtract = Join-Path $ReleaseRoot 'extracted'
        if (Test-Path $TempExtract) { Remove-Item -Recurse -Force $TempExtract }

        Expand-Archive -Path $LatestZip.FullName -DestinationPath $TempExtract -Force

        if (Test-Path (Join-Path $TempExtract 'rime_files')) {
          Move-Item -Path (Join-Path $TempExtract 'rime_files') -Destination $RimeFilesDir -Force
        } else {
          Move-Item -Path (Join-Path $TempExtract '*') -Destination $ReleaseRoot -Force
        }

        Remove-Item -Recurse -Force $TempExtract
        Write-Host "âœ… å·²å¾ $($LatestZip.Name) è§£å£“å®Œæˆã€‚"
      } else {
        Write-Host "âœ… ç™¼å¸ƒç”¨ rime_files å·²å­˜åœ¨ï¼Œè·³éè§£å£“ä½œæ¥­ã€‚"
      }

  - name: "å‚™ä»½ä½¿ç”¨è€…è‡ªè¨‚æª”æ¡ˆï¼ˆå«æ™‚é–“æˆ³è¨˜ï¼‰"
    run: |
      $RimeDir   = Join-Path $env:APPDATA 'Rime'
      $Timestamp = Get-Date -Format 'yyyyMMdd_HHmmss'
      $BackupTargets = @(
        'default.custom.yaml',
        'rime.lua',
        'custom_phrase.txt'
      )

      foreach ($file in $BackupTargets) {
        $Source = Join-Path $RimeDir $file
        if (Test-Path $Source) {
          $Backup = "$Source.bak_$Timestamp"
          Copy-Item -Path $Source -Destination $Backup -Force
          Write-Host "ğŸ“¦ å·²å‚™ä»½ $file -> $Backup"
        } else {
          Write-Host "â„¹ï¸  $file ä¸å­˜åœ¨ï¼Œç•¥éå‚™ä»½ã€‚"
        }
      }

  - name: "å»ºè­°æµç¨‹ï¼šåŸ·è¡Œ Python è‡ªå‹•å®‰è£è…³æœ¬"
    run: |
      $InstallerPy = Join-Path (Join-Path (Convert-Path .) 'tools') 'rime_installer.py'
      if (-not (Test-Path $InstallerPy)) {
        throw "æ‰¾ä¸åˆ° Python å®‰è£è…³æœ¬ï¼š$InstallerPy"
      }

      Write-Host "ğŸš€ ä»¥ Python åŸ·è¡Œ rime_installer.pyï¼Œè‡ªå‹•å®Œæˆæª”æ¡ˆè¤‡è£½èˆ‡é‡æ–°éƒ¨ç½²ã€‚"
      python $InstallerPy
      Write-Host "è‹¥ä¸Šè¿°è…³æœ¬æˆåŠŸå®Œæˆï¼Œå¾ŒçºŒæ‰‹å‹•æ­¥é©Ÿå¯è¦–æƒ…æ³ç•¥éã€‚"

  - name: "æ‰‹å‹•éƒ¨ç½²æ–¹æ¡ˆæª”æ¡ˆï¼ˆåƒ…åœ¨æœªåŸ·è¡Œè‡ªå‹•è…³æœ¬æ™‚ï¼‰"
    run: |
      $ProjectRoot = Convert-Path .
      $RimeDir     = Join-Path $env:APPDATA 'Rime'
      $IncludeFile = Join-Path $ProjectRoot 'release-include.txt'
      $IncludeList = Get-Content $IncludeFile | Where-Object {
        ($_ -ne '') -and (-not $_.Trim().StartsWith('#'))
      }

      $MissingFiles = @()
      foreach ($relative in $IncludeList) {
        $Source = Join-Path $ProjectRoot $relative
        $Destination = Join-Path $RimeDir (Split-Path $relative -Leaf)
        if (Test-Path $Source) {
          Copy-Item -Path $Source -Destination $Destination -Force
          Write-Host "âœ… å·²è¤‡è£½ $relative -> $Destination"
        } else {
          Write-Host "âŒ æ‰¾ä¸åˆ° $relative"
          $MissingFiles += $relative
        }
      }

      if ($MissingFiles.Count -gt 0) {
        throw "æœ‰ $($MissingFiles.Count) å€‹æª”æ¡ˆç¼ºå¤±ï¼Œè«‹æª¢æŸ¥ release-include.txt èˆ‡å¯¦éš›æª”æ¡ˆã€‚"
      }

  - name: "æ‰‹å‹•è¦†è“‹ default.custom.yamlï¼ˆè‹¥æœªé€éè…³æœ¬ï¼‰"
    run: |
      $ProjectRoot = Convert-Path .
      $RimeDir     = Join-Path $env:APPDATA 'Rime'
      $RimeFiles   = Join-Path $ProjectRoot 'release\rime_files\default.custom.yaml'
      $ConfigFile  = Join-Path $ProjectRoot 'config\default.custom.yaml'

      if (Test-Path $RimeFiles) {
        Copy-Item -Path $RimeFiles -Destination (Join-Path $RimeDir 'default.custom.yaml') -Force
        Write-Host "âœ… å·²ä½¿ç”¨ release\\rime_files ç‰ˆæœ¬è¦†è“‹ default.custom.yaml"
      } elseif (Test-Path $ConfigFile) {
        Copy-Item -Path $ConfigFile -Destination (Join-Path $RimeDir 'default.custom.yaml') -Force
        Write-Host "âœ… å·²ä½¿ç”¨ config ç‰ˆæœ¬è¦†è“‹ default.custom.yaml"
      } else {
        throw "æ‰¾ä¸åˆ°å¯ç”¨çš„ default.custom.yamlï¼Œè«‹ç¢ºèªä¾†æºæª”æ¡ˆæ˜¯å¦å­˜åœ¨ã€‚"
      }

  - name: "è§¸ç™¼å°ç‹¼æ¯«é‡æ–°éƒ¨ç½²"
    run: |
      $CandidatePaths = @(
        'C:\Program Files\Rime',
        'C:\Program Files (x86)\Rime'
      )

      $Deployer = $null
      foreach ($base in $CandidatePaths) {
        if (-not (Test-Path $base)) { continue }
        $Match = Get-ChildItem -Path $base -Directory -Filter 'weasel-*' |
                 Sort-Object LastWriteTime -Descending |
                 Select-Object -First 1
        if ($Match) {
          $Candidate = Join-Path $Match.FullName 'WeaselDeployer.exe'
          if (Test-Path $Candidate) {
            $Deployer = $Candidate
            break
          }
        }
      }

      if ($Deployer) {
        & $Deployer /deploy
      } else {
        Write-Host "âš ï¸  æœªè‡ªå‹•æ‰¾åˆ° WeaselDeployer.exeï¼Œè«‹æ–¼ç³»çµ±åŒ£æ‰‹å‹•é¸æ“‡ã€Œé‡æ–°éƒ¨ç½²ã€ã€‚"
      }

  - name: "é©—è­‰è¼¸å…¥æ–¹æ¡ˆèˆ‡è¾­å…¸"
    run: |
      # 1. æª¢æŸ¥æª”æ¡ˆæ˜¯å¦å·²åˆ°ä½
      $RimeDir = Join-Path $env:APPDATA 'Rime'
      Get-ChildItem -Path $RimeDir -Filter 'bp_*.schema.yaml'

      # 2. ä½¿ç”¨ python å·¥å…·æª¢æŸ¥é‡‹å‡ºæª”æ¡ˆï¼ˆè‹¥æœ‰ test_xlit_rules.py æˆ– test_bp_processing.pyï¼‰
      if (Test-Path '.\test\test_bp_processing.py') {
        python -m pytest test\test_bp_processing.py
      } else {
        Write-Host "â„¹ï¸  è‹¥éœ€æ›´å®Œæ•´çš„é©—è­‰ï¼Œå¯åŸ·è¡Œå·¥å…·\test_xlit_rules.py æˆ– pytestã€‚"
      }

      Write-Host "ğŸ‰ å®‰è£æµç¨‹å®Œæˆï¼Œè«‹æ–¼æ¡Œé¢ç³»çµ±åŒ£çš„å°ç‹¼æ¯«åœ–ç¤ºå³éµï¼Œç¢ºèªè¼¸å…¥æ–¹æ¡ˆåˆ—è¡¨å·²å‡ºç¾ã€Œé–©æ‹šã€ç›¸é—œæ–¹æ¡ˆã€‚"
