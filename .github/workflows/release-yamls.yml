name: "Build & Release YAML bundles (ALL / TLPA / ZU2 / BP)"

permissions:
  contents: write # â˜… è®“ GITHUB_TOKEN å¯ç™¼ Release / å»º tag

on:
  push:
    tags:
      - "v*"
      - "kb-*"
      - "bp-*"
      - "zu-*"
  workflow_dispatch:
    inputs:
      ref:
        description: "Branch æˆ– commitï¼ˆä¾‹ï¼šmainï¼a1b2c3dï¼‰"
        required: true
        default: "main"
      tag_name:
        description: "Release tagï¼ˆä¾‹ï¼šv0.9.0ï¼‰"
        required: true
      prerelease:
        description: "æ˜¯å¦æ¨™ç¤ºç‚º pre-release"
        type: boolean
        required: false
        default: false

jobs:
  build-windows-installer:
    runs-on: windows-latest
    steps:
      - name: Resolve ref / tag
        id: meta
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "REF=${{ github.event.inputs.ref }}" >> $GITHUB_OUTPUT
            echo "TAG=${{ github.event.inputs.tag_name }}" >> $GITHUB_OUTPUT
            echo "PRERELEASE=${{ github.event.inputs.prerelease }}" >> $GITHUB_OUTPUT
          else
            echo "REF=${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "TAG=${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "PRERELEASE=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ steps.meta.outputs.REF }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PyInstaller
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller

      - name: Build Windows installer
        run: |
          cd tools
          python build_installer.py
        shell: pwsh

      - name: Create installer package ZIP
        env:
          TAG: ${{ steps.meta.outputs.TAG }}
        run: |
          $tag = "$env:TAG"
          $zipName = "rime-bp-installer-${tag}.zip"
          Compress-Archive -Path "release\installer_package\*" -DestinationPath "dist\$zipName"

          # Generate SHA256
          $hash = Get-FileHash "dist\$zipName" -Algorithm SHA256
          "$($hash.Hash.ToLower())  $zipName" | Out-File -FilePath "dist\${zipName}.sha256" -Encoding ASCII

          Write-Host "Created: $zipName"
          Get-Item "dist\$zipName" | Format-List Name, Length
        shell: pwsh

      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: |
            dist/*.zip
            dist/*.sha256
          retention-days: 1

  build-bundles:
    runs-on: ubuntu-latest
    steps:
      - name: Resolve ref / tag
        id: meta
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "REF=${{ github.event.inputs.ref }}" >> $GITHUB_OUTPUT
            echo "TAG=${{ github.event.inputs.tag_name }}" >> $GITHUB_OUTPUT
            echo "PRERELEASE=${{ github.event.inputs.prerelease }}" >> $GITHUB_OUTPUT
          else
            echo "REF=${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "TAG=${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "PRERELEASE=false" >> $GITHUB_OUTPUT
          fi
          echo "Resolved REF=$(cat $GITHUB_OUTPUT | sed -n 's/^REF=//p'), TAG=$(cat $GITHUB_OUTPUT | sed -n 's/^TAG=//p')"

      - name: Checkout repository at ref
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ steps.meta.outputs.REF }}

      - name: Build 4 bundles (ALL/TLPA/ZU2/BP)
        shell: bash
        env:
          TAG: ${{ steps.meta.outputs.TAG }}
        run: |
          set -euo pipefail
          shopt -s nullglob nocaseglob

          echo "== [DEBUG] pwd: $(pwd) =="
          ls -l *.yaml || true

          PREFIX=""   # è‹¥æª”æ¡ˆä¸åœ¨æ ¹ç›®éŒ„ï¼Œæ”¹æˆä¾‹å¦‚ï¼šPREFIX="rime/"

          mkdir -p dist

          make_zip() {
            local name="$1"; shift
            local listfile="$1"; shift
            local zip="dist/rime-tlpa-${name}-${TAG}.zip"

            if [[ -s "$listfile" ]]; then
              echo ">>> Packing ${name} ($(wc -l < "$listfile") files)"
              zip -j "$zip" -@ < "$listfile" >/dev/null
              (cd dist && sha256sum "$(basename "$zip")" > "$(basename "$zip").sha256")
              ls -lh "dist/$(basename "$zip")"
            else
              echo "::warning::Skip ${name} (no files)"
            fi
          }

          # ---------- ALL ----------
          # 1) å„ªå…ˆä½¿ç”¨ release-include.txtï¼›2) ä¸å­˜åœ¨å°±æŠ“æ ¹ç›®éŒ„æ‰€æœ‰ *.yaml
          ALL_LIST="dist/_all.list"
          if [[ -f release-include.txt ]]; then
            echo "Use release-include.txt for ALL"
            awk 'NR==1{sub(/^\xef\xbb\xbf/,"")}{print}' release-include.txt \
              | sed -e 's/\r$//' -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//' \
              | sed -e '/^$/d' -e '/^#/d' \
              | while read -r p; do
                  [[ -z "$p" ]] && continue
                  f="${PREFIX}${p}"
                  [[ -f "$f" ]] && echo "$f"
                done > "$ALL_LIST"
          else
            echo "No release-include.txt, fallback to *.yaml"
            : > "$ALL_LIST"
            for f in ${PREFIX}*.yaml; do
              [[ -f "$f" ]] && echo "$f" >> "$ALL_LIST"
            done
          fi

          # ---------- COMMONï¼šå„æ–¹æ¡ˆå…±ç”¨ ----------
          COMMON_LIST="dist/_common.list"
          : > "$COMMON_LIST"
          for p in \
            rime.lua \
            keymap_piau_tian.yaml \
            lib_hau_suan_ji_tuann.yaml \
            lib_phing_im.yaml \
            lib_sip_ngoo_im.yaml \
            lib_sip_ngoo_im2.yaml \
            lib_zu_im.yaml
          do
            f="${PREFIX}${p}"
            [[ -f "$f" ]] && echo "$f" >> "$COMMON_LIST" || echo "::warning::Missing COMMON: $f"
          done

          # ---------- TLPA å°ˆå±¬ ----------
          TLPA_LIST="dist/_tlpa.list"
          : > "$TLPA_LIST"
          for pat in \
            tlpa_*.yaml tlpa_*.schema.yaml \
            tl_ji_khoo_*.dict.yaml
          do
            for f in ${PREFIX}${pat}; do
              [[ -f "$f" ]] && echo "$f" >> "$TLPA_LIST"
            done
          done
          # æ’é™¤ä»»ä½• *kb*ï¼ˆéµç›¤ç·´ç¿’å·¥å…·ï¼‰
          sed -i -e '/kb.*\.schema\.yaml/Id' "$TLPA_LIST" || true

          # ---------- æ³¨éŸ³äºŒå¼ï¼ˆZU2ï¼‰å°ˆå±¬ ----------
          ZU2_LIST="dist/_zu2.list"
          : > "$ZU2_LIST"
          for pat in \
            zu_im_2*.yaml zu_im_2*.schema.yaml
          do
            for f in ${PREFIX}${pat}; do
              [[ -f "$f" ]] && echo "$f" >> "$ZU2_LIST"
            done
          done
          sed -i -e '/kb.*\.schema\.yaml/Id' "$ZU2_LIST" || true

          # ---------- BP å°ˆå±¬ ----------
          BP_LIST="dist/_bp.list"
          : > "$BP_LIST"
          for pat in \
            bp_*.yaml bp_*.schema.yaml
          do
            for f in ${PREFIX}${pat}; do
              [[ -f "$f" ]] && echo "$f" >> "$BP_LIST"
            done
          done
          sed -i -e '/kb.*\.schema\.yaml/Id' "$BP_LIST" || true

          # ---------- éµç›¤ç·´ç¿’å·¥å…·ï¼ˆåªæ”¾ Allï¼‰ ----------
          KB_LIST="dist/_kb.list"
          : > "$KB_LIST"
          for pat in \
            kb_*.schema.yaml \
            *_kb*.schema.yaml
          do
            for f in ${PREFIX}${pat}; do
              [[ -f "$f" ]] && echo "$f" >> "$KB_LIST"
            done
          done

          # --------- åˆä½µæ¸…å–® ----------
          sort -u "$ALL_LIST" > dist/all.final
          cat "$COMMON_LIST" "$TLPA_LIST" | sort -u > dist/tlpa.final
          cat "$COMMON_LIST" "$ZU2_LIST"  | sort -u > dist/zu2.final
          cat "$COMMON_LIST" "$BP_LIST"   | sort -u > dist/bp.final

          # All å¦å¤–æŠŠ KB èˆ‡ COMMON ä¹Ÿä½µé€²å»ï¼ˆç¢ºä¿ rime.lua ç­‰å…±ç”¨æª”è¢«åŒ…å«ï¼‰
          cat dist/all.final "$COMMON_LIST" "$KB_LIST" | sort -u > dist/all.plus

          # ç°¡æ˜“åµæ¸¬ï¼šç¢ºèª rime.lua æ˜¯å¦å‡ºç¾åœ¨å„åŒ…æ¸…å–®
          for pkg in tlpa zu2 bp; do
            echo "[DEBUG] ${pkg}.final lines: $(wc -l < dist/${pkg}.final)"
            grep -n "rime\.lua" "dist/${pkg}.final" || echo "[DEBUG] rime.lua not found in dist/${pkg}.final"
          done
          echo "[DEBUG] all.plus lines: $(wc -l < dist/all.plus)"
          grep -n "rime\.lua" dist/all.plus || echo "[DEBUG] rime.lua not found in all.plus (will still proceed)"

          echo "== COUNT =="
          echo "ALL: $(wc -l < dist/all.plus) | TLPA: $(wc -l < dist/tlpa.final) | ZU2: $(wc -l < dist/zu2.final) | BP: $(wc -l < dist/bp.final)"

          # --------- æ‰“åŒ… ----------
          make_zip "all"  "dist/all.plus"
          make_zip "tlpa" "dist/tlpa.final"
          make_zip "zu2"  "dist/zu2.final"
          make_zip "bp"   "dist/bp.final"

      - name: Upload YAML bundles artifact
        uses: actions/upload-artifact@v4
        with:
          name: yaml-bundles
          path: |
            dist/*.zip
            dist/*.sha256
          retention-days: 1

  create-release:
    needs: [build-windows-installer, build-bundles]
    runs-on: ubuntu-latest
    steps:
      - name: Resolve ref / tag
        id: meta
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "REF=${{ github.event.inputs.ref }}" >> $GITHUB_OUTPUT
            echo "TAG=${{ github.event.inputs.tag_name }}" >> $GITHUB_OUTPUT
            echo "PRERELEASE=${{ github.event.inputs.prerelease }}" >> $GITHUB_OUTPUT
          else
            echo "REF=${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "TAG=${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "PRERELEASE=false" >> $GITHUB_OUTPUT
          fi

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release files
        run: |
          mkdir -p release-files
          # è¤‡è£½ YAML bundles
          if [ -d "artifacts/yaml-bundles" ]; then
            cp artifacts/yaml-bundles/* release-files/ || true
          fi
          # è¤‡è£½ Windows installer
          if [ -d "artifacts/windows-installer" ]; then
            cp artifacts/windows-installer/* release-files/ || true
          fi

          echo "=== Release files ==="
          ls -lh release-files/

      - name: Create / Update GitHub Release + upload all assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.TAG }}
          target_commitish: ${{ steps.meta.outputs.REF }}
          prerelease: ${{ github.event.inputs.prerelease || false }}
          body: |
            ## RIME é–©æ‹šè¼¸å…¥æ³• ${{ steps.meta.outputs.TAG }}

            ### ğŸ“¦ å®‰è£ç¨‹å¼ï¼ˆæ¨è–¦ï¼‰

            **Windows ä½¿ç”¨è€…**ï¼š
            1. ä¸‹è¼‰ `rime-bp-installer-${{ steps.meta.outputs.TAG }}.zip`
            2. è§£å£“ç¸®å¾ŒåŸ·è¡Œ `rime_installer.exe`
            3. æŒ‰ç…§ç¨‹å¼æŒ‡ç¤ºå®Œæˆå®‰è£

            ### ğŸ“‹ æ‰‹å‹•å®‰è£åŒ…

            - **rime-tlpa-all-${{ steps.meta.outputs.TAG }}.zip**: å®Œæ•´ç‰ˆï¼ˆåŒ…å«æ‰€æœ‰æ–¹æ¡ˆï¼‰
            - **rime-tlpa-tlpa-${{ steps.meta.outputs.TAG }}.zip**: TLPA å°ç¾…æ‹¼éŸ³æ–¹æ¡ˆ
            - **rime-tlpa-zu2-${{ steps.meta.outputs.TAG }}.zip**: æ³¨éŸ³äºŒå¼æ–¹æ¡ˆ
            - **rime-tlpa-bp-${{ steps.meta.outputs.TAG }}.zip**: é–©æ‹¼æ–¹æ¡ˆ

            ### ğŸ“ å®‰è£èªªæ˜

            **ä½¿ç”¨å®‰è£ç¨‹å¼**ï¼ˆæ¨è–¦ï¼‰ï¼š
            - é©ç”¨æ–¼æ‰€æœ‰ Windows ä½¿ç”¨è€…
            - è‡ªå‹•å‚™ä»½ç¾æœ‰é…ç½®
            - ä¸€éµå®Œæˆå®‰è£

            **æ‰‹å‹•å®‰è£**ï¼š
            1. ä¸‹è¼‰å°æ‡‰çš„ ZIP æª”æ¡ˆ
            2. è§£å£“ç¸®åˆ° RIME é…ç½®ç›®éŒ„ï¼š`%APPDATA%\Rime`
            3. é‡æ–°éƒ¨ç½² RIME

            ---

            SHA256 æ ¡é©—ç¢¼è«‹åƒè€ƒ `.sha256` æª”æ¡ˆ
          files: |
            release-files/*.zip
            release-files/*.sha256
