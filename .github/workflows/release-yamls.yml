name: "Build & Release é–©æ‹šè¼¸å…¥æ³• (BP)"

permissions:
  contents: write # â˜… è®“ GITHUB_TOKEN å¯ç™¼ Release / å»º tag

on:
  push:
    tags:
      - "v*"
      - "kb-*"
      - "bp-*"
      - "zu-*"
  workflow_dispatch:
    inputs:
      ref:
        description: "Branch æˆ– commitï¼ˆä¾‹ï¼šmainï¼a1b2c3dï¼‰"
        required: true
        default: "main"
      tag_name:
        description: "Release tagï¼ˆä¾‹ï¼šv0.9.0ï¼‰"
        required: true
      prerelease:
        description: "æ˜¯å¦æ¨™ç¤ºç‚º pre-release"
        type: boolean
        required: false
        default: false

jobs:
  build-windows-installer:
    runs-on: windows-latest
    steps:
      - name: Resolve ref / tag
        id: meta
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "REF=${{ github.event.inputs.ref }}" >> $GITHUB_OUTPUT
            echo "TAG=${{ github.event.inputs.tag_name }}" >> $GITHUB_OUTPUT
            echo "PRERELEASE=${{ github.event.inputs.prerelease }}" >> $GITHUB_OUTPUT
          else
            echo "REF=${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "TAG=${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "PRERELEASE=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ steps.meta.outputs.REF }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PyInstaller
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller

      - name: Build Windows installer
        env:
          PYTHONIOENCODING: utf-8
        run: |
          cd tools
          python build_installer.py
        shell: pwsh

      - name: Create installer package ZIP
        env:
          TAG: ${{ steps.meta.outputs.TAG }}
        run: |
          $tag = "$env:TAG"
          $zipName = "rime-bp-installer-${tag}.zip"
          Compress-Archive -Path "release\installer_package\*" -DestinationPath "dist\$zipName"

          # Generate SHA256
          $hash = Get-FileHash "dist\$zipName" -Algorithm SHA256
          "$($hash.Hash.ToLower())  $zipName" | Out-File -FilePath "dist\${zipName}.sha256" -Encoding ASCII

          Write-Host "Created: $zipName"
          Get-Item "dist\$zipName" | Format-List Name, Length
        shell: pwsh

      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: |
            dist/*.zip
            dist/*.sha256
          retention-days: 1

  build-bundles:
    runs-on: ubuntu-latest
    steps:
      - name: Resolve ref / tag
        id: meta
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "REF=${{ github.event.inputs.ref }}" >> $GITHUB_OUTPUT
            echo "TAG=${{ github.event.inputs.tag_name }}" >> $GITHUB_OUTPUT
            echo "PRERELEASE=${{ github.event.inputs.prerelease }}" >> $GITHUB_OUTPUT
          else
            echo "REF=${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "TAG=${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "PRERELEASE=false" >> $GITHUB_OUTPUT
          fi
          echo "Resolved REF=$(cat $GITHUB_OUTPUT | sed -n 's/^REF=//p'), TAG=$(cat $GITHUB_OUTPUT | sed -n 's/^TAG=//p')"

      - name: Checkout repository at ref
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ steps.meta.outputs.REF }}

      - name: Build BP bundle (é–©æ‹šæ–¹æ¡ˆ)
        shell: bash
        env:
          TAG: ${{ steps.meta.outputs.TAG }}
        run: |
          set -euo pipefail
          shopt -s nullglob nocaseglob

          echo "== å»ºç½®é–©æ‹šæ–¹æ¡ˆé…ç½®åŒ… =="
          echo "å·¥ä½œç›®éŒ„: $(pwd)"

          mkdir -p dist

          # å¾ release-include.txt è®€å–è¦æ‰“åŒ…çš„æª”æ¡ˆæ¸…å–®
          BP_LIST="dist/bp.list"

          if [[ -f release-include.txt ]]; then
            echo "è®€å– release-include.txt ä¸­çš„æª”æ¡ˆæ¸…å–®..."
            awk 'NR==1{sub(/^\xef\xbb\xbf/,"")}{print}' release-include.txt \
              | sed -e 's/\r$//' -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//' \
              | sed -e '/^$/d' -e '/^#/d' \
              | while read -r filename; do
                  [[ -z "$filename" ]] && continue
                  if [[ -f "$filename" ]]; then
                    echo "$filename"
                  else
                    echo "::warning::æª”æ¡ˆä¸å­˜åœ¨: $filename"
                  fi
                done > "$BP_LIST"

            file_count=$(wc -l < "$BP_LIST")
            echo "æ‰¾åˆ° $file_count å€‹æª”æ¡ˆ"

            # é¡¯ç¤ºæª”æ¡ˆæ¸…å–®ï¼ˆç”¨æ–¼é™¤éŒ¯ï¼‰
            echo "æª”æ¡ˆæ¸…å–®:"
            cat "$BP_LIST"

            # æ‰“åŒ…æˆ ZIP
            if [[ $file_count -gt 0 ]]; then
              zip_file="dist/rime-bp-${TAG}.zip"
              echo ">>> æ‰“åŒ…é–©æ‹šæ–¹æ¡ˆé…ç½® ($file_count å€‹æª”æ¡ˆ)"
              zip -j "$zip_file" -@ < "$BP_LIST"

              # ç”Ÿæˆ SHA256 æ ¡é©—ç¢¼
              (cd dist && sha256sum "$(basename "$zip_file")" > "$(basename "$zip_file").sha256")

              echo "âœ… æ‰“åŒ…å®Œæˆ:"
              ls -lh "$zip_file"
              echo "SHA256:"
              cat "${zip_file}.sha256"
            else
              echo "::error::æ²’æœ‰æ‰¾åˆ°è¦æ‰“åŒ…çš„æª”æ¡ˆ"
              exit 1
            fi
          else
            echo "::error::æ‰¾ä¸åˆ° release-include.txt æª”æ¡ˆ"
            exit 1
          fi

      - name: Upload YAML bundles artifact
        uses: actions/upload-artifact@v4
        with:
          name: yaml-bundles
          path: |
            dist/*.zip
            dist/*.sha256
          retention-days: 1

  create-release:
    needs: [build-windows-installer, build-bundles]
    runs-on: ubuntu-latest
    steps:
      - name: Resolve ref / tag
        id: meta
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "REF=${{ github.event.inputs.ref }}" >> $GITHUB_OUTPUT
            echo "TAG=${{ github.event.inputs.tag_name }}" >> $GITHUB_OUTPUT
            echo "PRERELEASE=${{ github.event.inputs.prerelease }}" >> $GITHUB_OUTPUT
          else
            echo "REF=${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "TAG=${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "PRERELEASE=false" >> $GITHUB_OUTPUT
          fi

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release files
        run: |
          mkdir -p release-files
          # è¤‡è£½ YAML bundles
          if [ -d "artifacts/yaml-bundles" ]; then
            cp artifacts/yaml-bundles/* release-files/ || true
          fi
          # è¤‡è£½ Windows installer
          if [ -d "artifacts/windows-installer" ]; then
            cp artifacts/windows-installer/* release-files/ || true
          fi

          echo "=== Release files ==="
          ls -lh release-files/

      - name: Create / Update GitHub Release + upload all assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.TAG }}
          target_commitish: ${{ steps.meta.outputs.REF }}
          prerelease: ${{ github.event.inputs.prerelease || false }}
          body: |
            ## RIME é–©æ‹šè¼¸å…¥æ³• ${{ steps.meta.outputs.TAG }}

            ### ğŸ“¦ Windows å®‰è£ç¨‹å¼ï¼ˆæ¨è–¦ï¼‰

            **é©ç”¨æ–¼ Windows ä½¿ç”¨è€…**ï¼š
            1. ä¸‹è¼‰ `rime-bp-installer-${{ steps.meta.outputs.TAG }}.zip`
            2. è§£å£“ç¸®å¾ŒåŸ·è¡Œ `rime_installer.exe`
            3. æŒ‰ç…§ç¨‹å¼æŒ‡ç¤ºå®Œæˆå®‰è£

            **å„ªé»**ï¼š
            - âœ… è‡ªå‹•å‚™ä»½ç¾æœ‰é…ç½®
            - âœ… ä¸€éµå®Œæˆå®‰è£
            - âœ… ç„¡éœ€æ‰‹å‹•è¤‡è£½æª”æ¡ˆ

            ### ğŸ“‹ æ‰‹å‹•å®‰è£åŒ…

            **rime-bp-${{ steps.meta.outputs.TAG }}.zip**: é–©æ‹šæ–¹æ¡ˆé…ç½®æª”æ¡ˆ

            **æ‰‹å‹•å®‰è£æ­¥é©Ÿ**ï¼š
            1. ä¸‹è¼‰ `rime-bp-${{ steps.meta.outputs.TAG }}.zip`
            2. è§£å£“ç¸®åˆ° RIME é…ç½®ç›®éŒ„ï¼š`%APPDATA%\Rime`
            3. é‡æ–°éƒ¨ç½² RIMEï¼ˆå³éµé»æ“Šç³»çµ±åŒ£ RIME åœ–ç¤º â†’ é‡æ–°éƒ¨ç½²ï¼‰

            ### ğŸ“ ç³»çµ±éœ€æ±‚

            - RIME å°ç‹¼æ¯«è¼¸å…¥æ³•ï¼ˆWindowsï¼‰
            - ä¸‹è¼‰ç¶²å€ï¼šhttps://rime.im/

            ### ğŸ” æª”æ¡ˆé©—è­‰

            æ¯å€‹ ZIP æª”æ¡ˆéƒ½é™„å¸¶ `.sha256` æ ¡é©—æª”æ¡ˆï¼Œå¯ç”¨æ–¼é©—è­‰ä¸‹è¼‰å®Œæ•´æ€§ã€‚

            ---

            é–©æ‹šè¼¸å…¥æ³•å°ˆæ¡ˆ | é–©å—èªç¾…é¦¬å­—æ¯æ‹¼éŸ³ç³»çµ±
          files: |
            release-files/*.zip
            release-files/*.sha256
